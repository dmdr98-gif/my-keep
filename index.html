<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Sync Keep</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',-apple-system,sans-serif;background:#f1f3f4;min-height:100vh}
        .header{background:#fff;padding:12px 20px;box-shadow:0 1px 3px rgba(0,0,0,.12);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
        .header h1{font-size:20px;color:#5f6368;font-weight:500}
        .header h1 span{color:#fbbc04}
        .status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px}
        .status-dot.connected{background:#34a853}
        .status-dot.disconnected{background:#ea4335}
        .status-dot.saving{background:#fbbc04}
        #statusText{font-size:12px;color:#80868b}
        .new-memo-area{max-width:600px;margin:24px auto 16px;padding:0 16px}
        .new-memo-box{background:#fff;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,.15);overflow:hidden}
        .new-memo-box:focus-within{box-shadow:0 2px 8px rgba(0,0,0,.2)}
        .new-memo-box textarea{width:100%;border:none;outline:none;padding:14px 16px;font-size:15px;font-family:inherit;resize:none;line-height:1.5;min-height:46px;color:#202124}
        .new-memo-box textarea::placeholder{color:#80868b}
        .new-memo-actions{display:none;padding:8px 12px;text-align:right;border-top:1px solid #f1f3f4}
        .new-memo-box:focus-within .new-memo-actions{display:flex;justify-content:space-between;align-items:center}
        .hint{font-size:11px;color:#9aa0a6;line-height:32px}
        .btn{padding:8px 20px;border:none;border-radius:4px;font-size:14px;font-family:inherit;cursor:pointer;font-weight:500;transition:background .15s}
        .btn-add{background:#1a73e8;color:#fff}
        .btn-add:hover{background:#1557b0}
        .btn-add:disabled{background:#dadce0;color:#80868b;cursor:default}
        .btn-save{background:#1a73e8;color:#fff}
        .btn-save:hover{background:#1557b0}
        .btn-cancel{background:transparent;color:#5f6368;margin-right:8px}
        .btn-cancel:hover{background:#f1f3f4}
        .btn-delete{background:transparent;color:#d93025;padding:6px 12px;font-size:13px}
        .btn-delete:hover{background:#fce8e6}
        .memo-list{max-width:600px;margin:0 auto;padding:0 16px 80px}
        .memo-card{background:#fff;border-radius:8px;margin-bottom:10px;box-shadow:0 1px 2px rgba(0,0,0,.1);overflow:hidden;border:1px solid #e0e0e0;transition:box-shadow .2s}
        .memo-card:hover{box-shadow:0 2px 6px rgba(0,0,0,.15)}
        .memo-view{padding:12px 16px;cursor:pointer;min-height:48px}
        .memo-content{font-size:14px;color:#202124;line-height:1.6;white-space:pre-wrap;word-break:break-word}
        .memo-time{font-size:11px;color:#9aa0a6;margin-top:8px}
        .memo-edit{display:none}
        .memo-edit textarea{width:100%;border:none;outline:none;padding:12px 16px;font-size:14px;font-family:inherit;resize:none;line-height:1.6;min-height:80px;color:#202124}
        .memo-edit-actions{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-top:1px solid #f1f3f4}
        .memo-card.editing{box-shadow:0 3px 10px rgba(0,0,0,.2);border-color:#1a73e8}
        .memo-card.editing .memo-view{display:none}
        .memo-card.editing .memo-edit{display:block}
        .empty-state{text-align:center;padding:60px 20px;color:#9aa0a6}
        .empty-state p{font-size:16px}
        .confirm-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:200;justify-content:center;align-items:center}
        .confirm-overlay.show{display:flex}
        .confirm-box{background:#fff;border-radius:12px;padding:24px;max-width:320px;width:90%;text-align:center}
        .confirm-box p{font-size:15px;color:#202124;margin-bottom:20px}
        .confirm-box .btn{margin:0 4px}
        .error-box{max-width:600px;margin:20px auto;padding:16px;background:#fce8e6;color:#d93025;border-radius:8px;font-size:14px;display:none}
    </style>
</head>
<body>

    <div class="header">
        <h1><span>&#9679;</span> My Sync Keep</h1>
        <div>
            <span class="status-dot disconnected" id="statusDot"></span>
            <span id="statusText">연결 중...</span>
        </div>
    </div>

    <div class="error-box" id="errorBox"></div>

    <div class="new-memo-area">
        <div class="new-memo-box">
            <textarea id="newMemoInput" placeholder="새 메모 작성..." rows="1"></textarea>
            <div class="new-memo-actions">
                <span class="hint">Ctrl+Enter로 추가</span>
                <button class="btn btn-add" id="addBtn" disabled>추가</button>
            </div>
        </div>
    </div>

    <div class="memo-list" id="memoList">
        <div class="empty-state" id="emptyState">
            <p>연결 대기 중...</p>
        </div>
    </div>

    <div class="confirm-overlay" id="confirmOverlay">
        <div class="confirm-box">
            <p>이 메모를 삭제하시겠습니까?</p>
            <button class="btn btn-cancel" id="confirmCancel">취소</button>
            <button class="btn btn-save" style="background:#d93025" id="confirmDelete">삭제</button>
        </div>
    </div>

    <!-- Firebase compat SDK (모바일 호환성 높음) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <script>
        window.onerror = function(msg) { showError('오류: ' + msg); };

        function showError(msg) {
            var box = document.getElementById('errorBox');
            box.textContent = msg;
            box.style.display = 'block';
        }

        try {
            firebase.initializeApp({
                apiKey: "AIzaSyALjheVaMZdCYxshJM6G0g4zXwdNBRZMEQ",
                authDomain: "database-4fc4f.firebaseapp.com",
                databaseURL: "https://database-4fc4f-default-rtdb.firebaseio.com",
                projectId: "database-4fc4f",
                storageBucket: "database-4fc4f.firebasestorage.app",
                messagingSenderId: "49818799571",
                appId: "1:49818799571:web:b70c9d98e87016c2a4f326"
            });

            var db = firebase.database();
            var memosRef = db.ref('memos');

            var newMemoInput = document.getElementById('newMemoInput');
            var addBtn = document.getElementById('addBtn');
            var memoList = document.getElementById('memoList');
            var emptyState = document.getElementById('emptyState');
            var statusDot = document.getElementById('statusDot');
            var statusText = document.getElementById('statusText');
            var confirmOverlay = document.getElementById('confirmOverlay');
            var confirmCancel = document.getElementById('confirmCancel');
            var confirmDeleteBtn = document.getElementById('confirmDelete');

            var currentEditingId = null;
            var deleteTargetId = null;

            function setStatus(type, text) {
                statusDot.className = 'status-dot ' + type;
                statusText.textContent = text;
            }

            function autoResize(el) {
                el.style.height = 'auto';
                el.style.height = el.scrollHeight + 'px';
            }

            // 새 메모 입력
            newMemoInput.addEventListener('input', function() {
                autoResize(this);
                addBtn.disabled = this.value.trim() === '';
            });

            newMemoInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    addMemo();
                }
            });

            addBtn.addEventListener('click', function() { addMemo(); });

            function addMemo() {
                var text = newMemoInput.value.trim();
                if (!text) return;
                setStatus('saving', '저장 중...');
                memosRef.push().set({
                    content: text,
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                }).then(function() {
                    newMemoInput.value = '';
                    newMemoInput.style.height = 'auto';
                    addBtn.disabled = true;
                    setStatus('connected', '실시간 동기화 중');
                }).catch(function(err) {
                    setStatus('disconnected', '저장 실패');
                    showError('저장 실패: ' + err.message);
                });
            }

            function formatTime(ts) {
                var d = new Date(ts);
                var now = new Date();
                var isToday = d.toDateString() === now.toDateString();
                function pad(n) { return String(n).padStart(2, '0'); }
                if (isToday) return '오늘 ' + pad(d.getHours()) + ':' + pad(d.getMinutes());
                return (d.getMonth()+1) + '/' + d.getDate() + ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes());
            }

            function createMemoCard(id, data) {
                var card = document.createElement('div');
                card.className = 'memo-card';
                card.setAttribute('data-id', id);

                var viewDiv = document.createElement('div');
                viewDiv.className = 'memo-view';
                var contentDiv = document.createElement('div');
                contentDiv.className = 'memo-content';
                contentDiv.textContent = data.content || '';
                var timeDiv = document.createElement('div');
                timeDiv.className = 'memo-time';
                timeDiv.textContent = data.updatedAt ? formatTime(data.updatedAt) : '';
                viewDiv.appendChild(contentDiv);
                viewDiv.appendChild(timeDiv);
                viewDiv.addEventListener('click', function() {
                    enterEditMode(card, id, data.content || '');
                });

                var editDiv = document.createElement('div');
                editDiv.className = 'memo-edit';
                var editTA = document.createElement('textarea');
                editTA.value = data.content || '';
                editTA.setAttribute('rows', '3');
                editTA.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        saveMemo(card, id, editTA.value);
                    }
                    if (e.key === 'Escape') cancelEdit(card);
                });
                editTA.addEventListener('input', function() { autoResize(this); });

                var actionsDiv = document.createElement('div');
                actionsDiv.className = 'memo-edit-actions';

                var deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-delete';
                deleteBtn.textContent = '삭제';
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    showDeleteConfirm(id);
                });

                var rightDiv = document.createElement('div');
                var cancelBtn = document.createElement('button');
                cancelBtn.className = 'btn btn-cancel';
                cancelBtn.textContent = '취소';
                cancelBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    cancelEdit(card);
                });
                var saveBtn = document.createElement('button');
                saveBtn.className = 'btn btn-save';
                saveBtn.textContent = '저장';
                saveBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    saveMemo(card, id, editTA.value);
                });

                rightDiv.appendChild(cancelBtn);
                rightDiv.appendChild(saveBtn);
                actionsDiv.appendChild(deleteBtn);
                actionsDiv.appendChild(rightDiv);
                editDiv.appendChild(editTA);
                editDiv.appendChild(actionsDiv);

                card.appendChild(viewDiv);
                card.appendChild(editDiv);
                return card;
            }

            function enterEditMode(card, id, content) {
                var editingCards = document.querySelectorAll('.memo-card.editing');
                for (var i = 0; i < editingCards.length; i++) {
                    if (editingCards[i] !== card) cancelEdit(editingCards[i]);
                }
                card.classList.add('editing');
                currentEditingId = id;
                var ta = card.querySelector('.memo-edit textarea');
                ta.value = content;
                setTimeout(function() {
                    autoResize(ta);
                    ta.focus();
                    ta.setSelectionRange(ta.value.length, ta.value.length);
                }, 50);
            }

            function cancelEdit(card) {
                card.classList.remove('editing');
                if (card.getAttribute('data-id') === currentEditingId) currentEditingId = null;
            }

            function saveMemo(card, id, newContent) {
                var text = newContent.trim();
                if (!text) { showDeleteConfirm(id); return; }
                setStatus('saving', '저장 중...');
                db.ref('memos/' + id).update({
                    content: text,
                    updatedAt: Date.now()
                }).then(function() {
                    card.classList.remove('editing');
                    currentEditingId = null;
                    setStatus('connected', '저장 완료');
                    setTimeout(function() { setStatus('connected', '실시간 동기화 중'); }, 1000);
                }).catch(function(err) {
                    setStatus('disconnected', '저장 실패');
                    showError('저장 실패: ' + err.message);
                });
            }

            function showDeleteConfirm(id) {
                deleteTargetId = id;
                confirmOverlay.classList.add('show');
            }

            confirmCancel.addEventListener('click', function() {
                confirmOverlay.classList.remove('show');
                deleteTargetId = null;
            });

            confirmDeleteBtn.addEventListener('click', function() {
                if (!deleteTargetId) return;
                setStatus('saving', '삭제 중...');
                db.ref('memos/' + deleteTargetId).remove().then(function() {
                    confirmOverlay.classList.remove('show');
                    deleteTargetId = null;
                    currentEditingId = null;
                    setStatus('connected', '삭제 완료');
                    setTimeout(function() { setStatus('connected', '실시간 동기화 중'); }, 1000);
                }).catch(function(err) {
                    setStatus('disconnected', '삭제 실패');
                });
            });

            confirmOverlay.addEventListener('click', function(e) {
                if (e.target === confirmOverlay) {
                    confirmOverlay.classList.remove('show');
                    deleteTargetId = null;
                }
            });

            // Firebase 실시간 수신
            memosRef.on('value', function(snapshot) {
                var data = snapshot.val();

                if (!data) {
                    var cards = memoList.querySelectorAll('.memo-card');
                    for (var i = 0; i < cards.length; i++) cards[i].remove();
                    emptyState.style.display = 'block';
                    emptyState.querySelector('p').textContent = '메모가 없습니다. 위에서 새 메모를 작성해보세요!';
                    setStatus('connected', '실시간 동기화 중');
                    return;
                }

                emptyState.style.display = 'none';

                var entries = Object.keys(data).map(function(key) {
                    return { id: key, data: data[key] };
                }).sort(function(a, b) {
                    return (b.data.updatedAt || b.data.createdAt || 0) - (a.data.updatedAt || a.data.createdAt || 0);
                });

                var editBackup = null;
                if (currentEditingId) {
                    var editCard = memoList.querySelector('.memo-card[data-id="' + currentEditingId + '"]');
                    if (editCard) {
                        var bta = editCard.querySelector('.memo-edit textarea');
                        if (bta) editBackup = { id: currentEditingId, value: bta.value };
                    }
                }

                var oldCards = memoList.querySelectorAll('.memo-card');
                for (var i = 0; i < oldCards.length; i++) oldCards[i].remove();

                var fragment = document.createDocumentFragment();
                for (var j = 0; j < entries.length; j++) {
                    var card = createMemoCard(entries[j].id, entries[j].data);
                    if (editBackup && editBackup.id === entries[j].id) {
                        card.classList.add('editing');
                        var eta = card.querySelector('.memo-edit textarea');
                        eta.value = editBackup.value;
                        (function(el) { setTimeout(function() { autoResize(el); }, 50); })(eta);
                    }
                    fragment.appendChild(card);
                }

                memoList.insertBefore(fragment, emptyState);
                setStatus('connected', '실시간 동기화 중');

            }, function(error) {
                setStatus('disconnected', '연결 실패');
                showError('Firebase 연결 실패: ' + error.message);
            });

            // 연결 상태 모니터링
            db.ref('.info/connected').on('value', function(snap) {
                if (snap.val() === true) {
                    setStatus('connected', '실시간 동기화 중');
                    document.getElementById('errorBox').style.display = 'none';
                } else {
                    setStatus('disconnected', '연결 끊김');
                }
            });

        } catch(e) {
            showError('초기화 오류: ' + e.message);
        }
    </script>
</body>
</html>
